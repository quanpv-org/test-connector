name: CI-Build

on:
  push:
  pull_request:
  schedule:
    - cron:  '21 21 * * *'
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write
  
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Check translations by non-weblate author
      run: |
        if [ -n "${{ github.event.pull_request.user.login }}" ]; then
          AUTHOR="${{ github.event.pull_request.user.login }}"
          EVENT_TYPE="pull_request"
        elif [ -n "${{ github.event.pusher.name }}" ]; then
          AUTHOR="${{ github.event.pusher.name }}"
          EVENT_TYPE="push"
        elif [ -n "${{ github.event.sender.login }}" ]; then
          AUTHOR="${{ github.event.sender.login }}"
          EVENT_TYPE="workflow_dispatch_or_other"
        else
          AUTHOR="${{ github.actor }}"
          EVENT_TYPE="fallback"
        fi
        if [ "$AUTHOR" = "weblate" ]; then
          echo "✓ Author is weblate, bypassing README_DE.md check"
        else
          echo "Author is not weblate ($AUTHOR), checking README_DE.md modifications"
          BASE_BRANCH="${{ github.event.repository.default_branch }}"
          git fetch origin $BASE_BRANCH
          if git ls-tree -r origin/$BASE_BRANCH --name-only | grep -q 'README_DE\.md$'; then
            if ! git diff --exit-code origin/$BASE_BRANCH...HEAD -- '**/README_DE.md'; then
              echo "⚠ ERROR: Modification of README_DE.md is not allowed."
              exit 1
            fi
          else
            echo "✓ README_DE.md does not exist on default branch, file can be created."
          fi
        fi
